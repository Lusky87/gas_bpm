<%@ page language="java" contentType="text/html; charset=UTF-8" pageEncoding="UTF-8"%>
<%@ page import="com.hncis.common.util.*"%>
<%@ include file="/hncis/include/common_sub.gas"%>
<%
	String menuId = "XPS01";
	String M_DOC_NO = StringUtil.replaceParameter(StringUtil.isNullToString(request.getParameter("M_DOC_NO")));
	String M_EENO = StringUtil.replaceParameter(StringUtil.isNullToString(request.getParameter("M_EENO")));
	String T_DOC_NO = StringUtil.replaceParameter(StringUtil.isNullToString(request.getParameter("M_DOC_NO")));
	String hid_csrfToken  = StringUtil.replaceParameter(StringUtil.isNullToString(request.getParameter("hid_csrfToken")));
	String hid_cond 	  = StringUtil.replaceParameter(StringUtil.isNullToString(request.getParameter("hid_cond")));
	String hid_view_nm    = StringUtil.replaceParameter(StringUtil.isNullToString(request.getParameter("hid_view_nm")));

	String yy = CurrentDateTime.getDate().substring(0, 4);
	String mm = CurrentDateTime.getDate().substring(4, 6);
	String dd = CurrentDateTime.getDate().substring(6, 8);

	String yymmdd = yy + "-" + mm + "-" + dd;

	String yy1 = CurrentDateTime.getDate().substring(0, 4);
	String mm1 = CurrentDateTime.getDate().substring(4, 6);
	String dd1 = CurrentDateTime.getDate().substring(6, 8);
	String ddmmyy = dd+ "/" + mm + "/" + yy;
	String ddmmyy1 = dd1+ "/" + mm1 + "/" + yy1;

	String strNew = JSPMessageSource.getMessage("BUTTON.NEW",locale);
	String strSav = JSPMessageSource.getMessage("BUTTON.SAVE", locale);
	String strDel = JSPMessageSource.getMessage("BUTTON.DELETE", locale);
	String strReq = JSPMessageSource.getMessage("BUTTON.REQUEST", locale);
	String strRqc = JSPMessageSource.getMessage("BUTTON.REQUESTCANCEL", locale);
	String strCfm = JSPMessageSource.getMessage("BUTTON.CONFIRM", locale);
	String strCfc = JSPMessageSource.getMessage("BUTTON.CONFIRMCANCEL", locale);
	String strPrn = JSPMessageSource.getMessage("BUTTON.PRINT", locale);
	String strBck = JSPMessageSource.getMessage("BUTTON.BACK", locale);

	if(StringUtil.isEmpty(M_DOC_NO)){
		T_DOC_NO = StringUtil.getDocNo();
	}

	String strBtn = "";
	strBtn = strNew+"/new@"+strSav+"/save@"+strDel+"/delete@"+strReq+"/request@"+strRqc+"/requestCancel@"+strCfm+"/confirm@"+strCfc+"/reject";
	if(!"".equals(M_DOC_NO)){
		strBtn += "@"+strBck+"/back";
	}

	String approveStepLevel = CommonGasc.getApproveStepLevel(menuId, request);

	String tempPath     = request.getServletPath().toString();
	String stepHelpUrl  = StringUtil.getStepHelp(tempPath);
%>
<html>
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
		<title>픽업</title>
	</head>
	<body>
		<div id="wrap">
	    	<form name="frm" id="frm">
				<input type="hidden" id="M_DOC_NO" value="<%=M_DOC_NO%>">
				<input type="hidden" id="T_DOC_NO" value="<%=T_DOC_NO%>">
				<input type="hidden" id="M_EENO" value="<%=M_EENO%>">
				<input type="hidden" id="ipe_eeno">
				<input type="hidden" id="pgs_st_cd">
				<input type="hidden" id="acpc_pgs_st_cd">
				<input type="hidden" id="if_id">
				<input type="hidden" id="cost_cd_h">
				<input type="hidden" id="budg_no_h">
				<input type="hidden" id="budg_type_h" name="budg_type_h">
				<input type="hidden" id="hid_cond" name="hid_cond" value="<%=hid_cond%>">
				<input type="hidden" id="hid_view_nm" name="hid_view_nm" value="<%=hid_view_nm%>">
				<input type="hidden" id="po_no" name="po_no">
				<input type="hidden" id="approveStepLevel" value="<%=approveStepLevel%>">
				<input type="hidden" id="help_url" name="help_url" value="<%=stepHelpUrl%>">

		    	<%@ include file="../include/hncis_header.gas"%>
		        <div id="contents_wrap">
		        	<%@ include file="../include/hncis_left.gas"%>
		            <div id="contents">
		            	<%=CommonGasc.getTitleAndButtonNew(
							sess_empno
							,menuId
							,strBtn
							,"1"
							,"3"
							,null
							,"Y"
							,request)
						%>
						<div id="basic">
							<div class="con_t_area">
			                	<h3><fmt:message key="basic_info"/></h3>
			                </div>
			                <div class="search_area">
			                	<table>
			                        <colgroup>
			                        	<col style="width:100px;" />
			                            <col style="width:165px;" />
			                            <col style="width:60px;" />
			                            <col style="width:160px;" />
			                            <col style="width:60px;" />
			                            <col style="width:160px;" />
			                            <col style="width:80px;" />
			                            <col style="width:auto;" />
			                        </colgroup>
			                        <tbody>
			                            <tr>
											<th><fmt:message key="eeno"/></th>
											<td>
												<input type="text" id="eeno" name="eeno" style="width:140px;ime-mode:disabled;" onkeyup="setInsaInfo();" value="<%=sess_empno %>" class="disabled" readOnly>
											</td>
											<th><fmt:message key="eenm"/></th>
											<td>
												<input type="text" id="eeno_nm" name="eeno_nm" style="width:140px;" class="disabled" readOnly/>
											</td>
											<th><fmt:message key="position"/></th>
											<td>
												<input type="text" id="pos_nm" name="pos_nm" style="width:140px;" class="disabled" readOnly/>
											</td>
											<th><fmt:message key="dept_nm"/></th>
											<td>
												<input type="text" id="dept_nm" name="dept_nm" style="width:140px;" class="disabled" readOnly/>
											</td>
										</tr>
										<tr>
											<th><fmt:message key="req_ymd"/></th>
											<td>
												<input type="text" id="ptt_ymd" name="ptt_ymd" style="width:140px;" class="disabled" readOnly/>
											</td>
											<th><fmt:message key="doc_no"/></th>
											<td>
												<input type="text" id="doc_no" name="doc_no" style="width:140px;" class="disabled" readOnly/>
											</td>
											<th><fmt:message key="pgs_st_nm"/></th>
											<td>
												<input type="text" id="pgs_st_cd_d" name="pgs_st_cd_d" style="width:140px;" class="disabled" readOnly/>
											</td>
											<th><fmt:message key="tel_no"/></th>
											<td>
												<input type="text" id="tel_no" name="tel_no" style="width:140px;" class="disabled" readOnly/>
											</td>
										</tr>
										<tr>
											<th><fmt:message key="rtn_rsn"/></th>
											<td colspan="7">
												<input type="text" id="snb_rson_sbc" name="snb_rson_sbc" style="width:826px" class="disabled" readOnly>
											</td>
										</tr>
			                        </tbody>
			                    </table>
			                </div>
			                <div id="pickup">
								<table>
									<colgroup>
			                        	<col style="width:120px;" />
			                            <col style="width:750px;" />
			                            <col style="width:70px;" />
			                            <col style="width:auto;" />
			                        </colgroup>
									<tr>
										<th><fmt:message key="car_type"/></th>
										<th><fmt:message key="purp"/></th>
										<th colspan="2"><fmt:message key="att_file"/></th>
									</tr>
									<tr>
										<td>
											<select id="car_type_cd" name="car_type_cd" style="width:98%" onchange="searchFromPlaceCombNew();" class="req-data2">
											</select>
										</td>
										<td>
											<input type="text" id="purp_sbc" name="purp_sbc" style="width:99%" >
										</td>
										<td class="t_center">
											<img src='../../images/hncis_bttn/open-n.gif' onClick='doFileAttach();'/>
										</td>
										<td class="t_center">
											<input type="text" id="file_yn" name="file_yn" style="width:30px;border:0px;" readonly/>
										</td>
									</tr>
								</table>
							</div>
							<div class="con_t_area">
			                	<h3 class="fl"><fmt:message key="pkup_schedule"/></h3>
			                	<div class="btn_area mt0">
				                    <ul class="btns fr ml20">
				                        <!-- <li><a href="javascript:fnAddSchedule();">일정추가<span></span></a></li> -->
				                        <li><a href="javascript:gridRowAdd();"><fmt:message key="BUTTON.ADD"/><span></span></a></li>
				                        <li><a href="javascript:gridRowDelete();"><fmt:message key="BUTTON.DELETE"/><span></span></a></li>
				                        <li><a href="javascript:gridRowExcel();"><fmt:message key="BUTTON.EXCEL"/><span></span></a></li>
				                    </ul>
				                </div>
			                </div>
			                <div class="jq_tbl">
				                <table id="htmlTable" class="scroll"></table>
							</div>
			                <%@ include file="../include/hncis_message.gas"%>
			            </div>
			            <div class="clear"></div>
			        </div>
			    </div>
	        </form>
			<form id="fileForm" name="fileForm">
				<input type="hidden" id="hid_doc_no" name="hid_doc_no" value="<%=M_DOC_NO%>">
				<input type="hidden" id="hid_eeno"  name="hid_eeno" >
				<input type="hidden" id="hid_seq"  name="hid_seq">
				<input type="hidden" id="hid_use_yn"  name="hid_use_yn">
				<input type="hidden" id="hid_csrfToken" name="hid_csrfToken">
			</form>
			<form id="hideForm" name="hideForm" method="post">
				<input type="hidden" id="hid_csrfToken"	name="hid_csrfToken">
			</form>
	    </div>
	    <img id="loading_progress_img" src="<%=ctxPath %>/images/common/progress_bar.gif" width="362" height="131" style="display:none" />
	</body>
</html>
		<script type="text/javascript">
		var sess_auth = $("#work_auth").val();
		var row_no = 0;
		var params;
		var fnMerge;
		var comboVal;
		var comboVal1;
		var comboVal2;
		var comboVal_tmp1;
		var comboVal_tmp2;
		var comboEmp = '<option role="option" value=""></option>';
		var gridName1 = "htmlTable";
		var datarow = {stap_ymd:"",sta_hhmm:"",stap_cd:"",stap_adr:"",arvp_cd:"",arvp_adr:"",rem_sbc:"",flht_no:"",svca_amt:"",doc_no:"",seq:"",add_flag:"", po_no:""};
		var tmpAgencyData;

		var excelCn = ['<fmt:message key="date_time"/>' // "일시"
		               ,'<fmt:message key="dept_time"/>' // "출발시간"
		               ,'<fmt:message key="place"/>' // "장소"
		               ,'<fmt:message key="dtl_info"/>' // "상세정보"
		               ,'<fmt:message key="place"/>' // "장소"
		               ,'<fmt:message key="dtl_info"/>' // "상세정보"
		               ,'<fmt:message key="eenm"/>' // "이름"
		               ,'<fmt:message key="etc"/>' // "기타"
		               ];
		var excelCm = ['stap_ymd','sta_hhmm','stap_nm','stap_adr','arvp_nm','arvp_adr','rem_sbc','flht_no'];
		var excelFm = ['string','string','string','string','string','string','string','string'];

		function fnSetDocumentReady(){
			initMenus();
			$('#PS').slideDown('fast');
			$(".inputOnlyNumber").numeric();

			getCommonCode("cd_stap_cd:XPS03;cd_arvp_cd:XPS03;", "Y", "", "/getCommonComboByTask.do");
			getCommonCode("car_type_cd:XPS01:S;", "N", "getKeyCombo('firm_cd')", "/getCommonComboByTask.do");

			chk_auth();

			$("#contents>.btn_area").show();
			$('#policy').slideUp();

			fnChkApplyReqsObjects2();
		}

		function getKeyCombo(codeStr){
			var codknd = "";
			switch (codeStr) {
			case "firm_cd": codknd = "firm_cd:Z";
				break;
			case "firm_cd2": codknd = "firm_cd2:S";
				break;
			}
			getKeyMultiCombo(codknd);
		};

		function getKeyMultiCombo(codeStr){
			var keyData = {
				codknd : codeStr,
				corp_cd	: sess_corp_cd
			};

			doCommonAjax("doSearchPsToCombo.do", keyData, "searchFromPlaceComb(jsonData.sendResult);");
		}

		function searchFromPlaceComb(agencyData){
			tmpAgencyData = agencyData;

			var ids = jQuery("#"+gridName1).getDataIDs();

			for(var i=0 ; i < ids.length ; i++  ){
				rowId = ids[i];
				if(rowId != jQuery("#"+gridName1).jqGrid("getGridParam", "selrow")){
					$("select#" + rowId +"_stap_cd").html(comboEmp);
					$("select#" + rowId +"_arvp_cd").html(comboEmp);
					$("#htmlTable").setCell(rowId,'stap_cd',null);
					$("#htmlTable").setCell(rowId,'arvp_cd',null);
				}
			}

			var params = {
				cb_key		: "",
				gubn		: "f",
				corp_cd		: sess_corp_cd
			};

			doCommonAjax("doSearchPsToMultiCombo.do", params,"comboCallBack(jsonData.sendResult);");
		}

		function comboCallBack(jsonData){
			comboVal1 = jsonData;
			comboVal_tmp1 = jsonData;

			searchFromPlaceComb2();
		}

		function searchFromPlaceComb2(){
			var params = {
				cb_key		: "",
				gubn		: "t",
				corp_cd		: sess_corp_cd
			};

			doCommonAjax("doSearchPsToMultiCombo.do", params,"comboCallBack2(jsonData.sendResult);");
		}

		function comboCallBack2(jsonData){
			comboVal2 = jsonData;
			comboVal_tmp2 = jsonData;

			var rowId = jQuery("#"+gridName1).jqGrid("getGridParam", "selrow");
			if(rowId != null){
				setMiltiComboList(rowId,'stap_cd');
			}

			fnSetAgencyData();
		}

		function fnSetAgencyData(){
			if($("#M_DOC_NO").val() == ""){
				$("#eeno").val(sess_empno);
				$("#eeno_nm").val(sess_name);
				$("#pos_nm").val(sess_step_name);
				$("#dept_nm").val(sess_dept_name);
				$("#tel_no").val(sess_tel_no);
				$("#ptt_ymd").val(getCurrentToDateAddDayEn("/",0));

				init();
			}else{
				doSearch();
			}
		}

		function searchFromPlaceCombNew(){
			var ids = jQuery("#"+gridName1).getDataIDs();

			for(var i=0 ; i < ids.length ; i++  ){
				rowId = ids[i];
				if(rowId != jQuery("#"+gridName1).jqGrid("getGridParam", "selrow")){
					$("select#" + rowId +"_stap_cd").html(comboEmp);
					$("select#" + rowId +"_arvp_cd").html(comboEmp);
					$("#htmlTable").setCell(rowId,'stap_cd',null);
					$("#htmlTable").setCell(rowId,'arvp_cd',null);
				}
			}

			var rowId = jQuery("#"+gridName1).jqGrid("getGridParam", "selrow");
			if(rowId != null){
				setMiltiComboList(rowId,'stap_cd');
			}
		}

		function setTsGridValue(rowId, iCol, cellcontent){
			var colNm = jQuery('#htmlTable').jqGrid('getGridParam', 'colModel')[iCol].index;

			var rowId = jQuery("#"+gridName1).jqGrid("getGridParam", "selrow");
			if($('#car_type_cd').val() == '' && rowId != null){
				$("select#" + rowId +"_stap_cd").html(comboEmp);
				$("select#" + rowId +"_arvp_cd").html(comboEmp);
			}else{
				setMiltiComboList(rowId,'stap_cd');
			}

			if($('#car_type_cd').val() == ''){
				alertUI('<fmt:message key="MSG.SEL.0025"/>','','$("#car_type_cd").focus();');
				//$("#car_type_cd").focus();
				return;
			}
		}

		function setMiltiComboList(rowId,colNm){
			if(typeof(comboVal_tmp1) == 'undefined'){return;}
			if(colNm == 'stap_cd'){
				var colValueCarType = $('#car_type_cd').val();
				var tmpVal1 = getColValue(colNm, rowId, gridName1);
				tmpComboVal1 ="";
				$.each(eval(comboVal_tmp1),function(targetNm,optionData){
					$.each(eval(optionData),function(index,optionData){
		    			if(targetNm=='FROM_PLACE'&& colValueCarType == optionData.key){
		    				tmpComboVal1 += '<option role="option" value="' +
				            optionData.code + '">' +
							optionData.value + '</option>';

		        		}
					});
				});
				if(tmpComboVal1 == ''){
					tmpComboVal1 = comboEmp;
				}
				$("select#" + rowId +"_"+colNm).html(tmpComboVal1);
				$("select#" + rowId +"_"+colNm).val(tmpVal1);

				setMiltiComboList(rowId,'arvp_cd');
			}
			else if(colNm == 'arvp_cd'){
				var colValueCarType = $('#car_type_cd').val();
				var stapCd = colValueCarType + "" + getColValue("stap_cd",rowId);
				var tmpVal2 = getColValue(colNm, rowId, gridName1);
				tmpComboVal2="";
				$.each(eval(comboVal_tmp2),function(targetNm,optionData){
					$.each(eval(optionData),function(index,optionData){
		    			if(targetNm=='TO_PLACE'&& stapCd == optionData.key){
		    				tmpComboVal2 += '<option role="option" value="' +
				            optionData.code + '">' +
							optionData.value + '</option>';

		        		}
					});
				});
				if(tmpComboVal2 == ''){
					tmpComboVal2 = comboEmp;
				}

				$("select#" + rowId +"_"+colNm).html(tmpComboVal2);
				$("select#" + rowId +"_"+colNm).val(tmpVal2);
			}
		}

		function getComboValue1(comboName){
			var returnVal;
			if(typeof(comboVal_tmp1) == 'undefined'){
				returnVal = ":";
			}
			else{
				var i = 0;
				$.each(eval(comboVal_tmp1),function(targetNm,optionData){
		 			if(targetNm == comboName){
						$.each(eval(optionData),function(index,optionData){
							if(i == 0){
								returnVal = returnVal + optionData.code + ":" + optionData.value;
							}else{
								returnVal = returnVal + ";" + optionData.code + ":" + optionData.value;
							}
							i++;
						});
					}
			      });
				if(typeof(returnVal) == 'undefined'){
					returnVal = '';
				}
				else{
					returnVal = returnVal.replace("undefined", "");
				}
			}
			return returnVal;
		}

		function getComboValue2(comboName){
			var returnVal;
			if(typeof(comboVal_tmp2) == 'undefined'){
				returnVal = ":";
			}
			else{
				var i = 0;
				$.each(eval(comboVal_tmp2),function(targetNm,optionData){
					if(targetNm == comboName){
						$.each(eval(optionData),function(index,optionData){
							if(i == 0){
								returnVal = returnVal + optionData.code + ":" + optionData.value;
							}else{
								returnVal = returnVal + ";" + optionData.code + ":" + optionData.value;
							}
							i++;
						});
					}
				});
				if(typeof(returnVal) == 'undefined'){
					returnVal = '';
				}
				else{
					returnVal = returnVal.replace("undefined", "");
				}
			}
			return returnVal;
		}

		function getAgencyComboValue(comboName){
			var returnVal = "";
			var i = 0;

			$.each(eval(tmpAgencyData),function(targetNm,optionData){
				if(targetNm == comboName){
					$.each(eval(optionData),function(index,optionData){
						if(returnVal == ""){
							returnVal = returnVal + htmlDecode(optionData.value) + ":" + htmlDecode(optionData.name);
						}else{
							returnVal = returnVal + ";" + htmlDecode(optionData.value) + ":" + htmlDecode(optionData.name);
						}
						i++;
					});
				}
		    });

			return returnVal;
		}

		function init(flag){
			$("#htmlTable").GridUnload();

			previRow = "";
			previRow2 = "";

// 			cn = ['일시','출발시간','장소','상세정보','장소','상세정보','이름','항공번호','금액','Doc No','Seq','', ''];
			var cn = ['<fmt:message key="date_time"/>' // "일시"
			          ,'<fmt:message key="dept_time"/>' // "출발시간"
			          ,'<fmt:message key="place"/>' // "장소"
			          ,'<fmt:message key="dtl_info"/>' // "상세정보"
			          ,'<fmt:message key="place"/>' // "장소"
			          ,'<fmt:message key="dtl_info"/>' // "상세정보"
			          ,'<fmt:message key="eenm"/>' // "이름"
			          ,'<fmt:message key="etc"/>' // "기타"
			          ,'' // "금액"
			          ,'' // "doc+no"
			          ,'' // "seq"
			          ,'' // ""
			          ,'' // ""
		          ];
			cm = [
		      		{name:"stap_ymd", index:"stap_ymd", sortable:false, formatter:"string",	width:65, readonly:"true", align:"center", editable:true,	frozen : false,
						editoptions: {
							readonly : true,
				            dataInit: function(element) {
				     		    $(element).datepicker({
				     		    	dateFormat: 'yy-mm-dd',
				     		    	onSelect: function(dataText, inst){
				     		    	}
						    	});
				            }
						}
					},
					{name:"sta_hhmm", index:"sta_hhmm", sortable:false,	formatter:"string",	width:60, align:"center", editable:true, frozen : false,
						editoptions: {maxlength:"4",
				            dataInit: function(element) {
				     		    $(element).keyup(function(){

				     		    	if(!isNumeric(element.value)){
				     		    		element.value = selectNum(element.value);
				     		    	}

				     		    	if(trimChar(element.value, ":").length == 4){
				     		    		if(element.value.length > 4){
				     		    			element.value = "";
				     		    		}else{
				     		    			element.value = element.value.substring(0, 2)+":"+element.value.substring(2, 4);
				     		    			check_time(element);
				     		    		}
				     				}else{
				     					element.value = trimChar(element.value, ":");
				     				}
				     		    });
				            }
				        }
					},
					{name:'stap_cd',index:'stap_cd',sortable:false,width:115,align:'center',editable:true,															//12
						edittype:'select', formatter: "select",
						editoptions:{value:getComboValue1('FROM_PLACE'),
				        	dataEvents:[{type:'change',
								fn:function(e){
					        		var row = $(e.target).closest('tr.jqgrow');
				                    var rowId = row.attr('id');
				                    var cbs = jQuery("#jqg_"+gridName1+"_"+rowId);
			                        if(!cbs.is(":checked")){
			                        	jQuery("#"+gridName1).jqGrid("setSelection", rowId, true);
			                        }

				                    $("select#" + rowId +"_arvp_cd").html(comboEmp);

				                    setMiltiComboList(rowId,'arvp_cd');
				        		}
				        	}
				        	]
				        	,dataInit: function(elem) {
					        	$(elem).width(111);
					    	}
					    }
					},
					{name:'stap_adr',index:'stap_adr', formatter: "string",width:138,align:'left',editable:true,sortable:false},
					{name:'arvp_cd',index:'arvp_cd',sortable:false,width:115,align:'center',editable:true,															//12
						edittype:'select', formatter: "select",
						editoptions:{value:getComboValue2('TO_PLACE'),
				        	dataEvents:[{type:'change',
								fn:function(e){
					        		var row = $(e.target).closest('tr.jqgrow');
				                    var rowId = row.attr('id');
				                    var cbs = jQuery("#jqg_"+gridName1+"_"+rowId);
			                        if(!cbs.is(":checked")){
			                        	jQuery("#"+gridName1).jqGrid("setSelection", rowId, true);
			                        }
				        		}
				        	}
				        	]
				        	,dataInit: function(elem) {
					        	$(elem).width(111);
					    	}
					    }
					},
					{name:'arvp_adr',index:'arvp_adr', formatter: "string",width:137,align:'left',editable:true,sortable:false},
					{name:'rem_sbc',index:'rem_sbc', formatter: "string",width:185,align:'left',editable:true,sortable:false},
					{name:'flht_no',index:'flht_no', formatter: "string",width:125,align:'left',editable:true,sortable:false},
					{name:'svca_amt',index:'svca_amt', formatter: "string",width:60,align:'right',editable:false,sortable:false, hidden:true},
					{name:'doc_no',index:'doc_no', formatter: "string",width:60,align:'left',editable:true,sortable:false,hidden:true},
					{name:'seq',index:'seq', formatter: "string",width:60,align:'left',editable:true,sortable:false,hidden:true},
					{name:'add_flag',index:'add_flag', formatter: "string",width:60,align:'left',editable:true,sortable:false,hidden:true},
					{name:'po_no',index:'po_no', formatter: "string",width:60,align:'left',editable:true,sortable:false,hidden:true}
			];

			url = $("#M_DOC_NO").val() == "" ? "/doSearchToEmpty.do" : "doSearchListPsToRequest.do";

			var params = {
				doc_no		: $('#M_DOC_NO').val(),
				corp_cd		: sess_corp_cd
			};

			gridParam = {
				viewEdit : [{
					gridName     : "htmlTable",
					url          : url,
					colNames     : cn,
					colModel     : cm,
					height       : "100%",
					sortname     : "stap_ymd",
					sortorder    : "desc",
					rownumbers   : true,
					multiselect  : true,
					cellEdit     : true,
					fnMerge      : false,
					paramJson    : params,
					selectCellFc : "setTsGridValue(rowid, iCol, cellcontent);",
					completeFc   : "fnInitGridComplete('htmlTable');"
				}]
			};

			commonJqGridInit(gridParam, "N");

			jQuery("#htmlTable").jqGrid('setGroupHeaders', {
				useColSpanStyle: true,
				groupHeaders:[
			          {startColumnName: 'stap_cd', numberOfColumns: 2, titleText: '<fmt:message key="dept_nm1" />'},
			          {startColumnName: 'arvp_cd', numberOfColumns: 2, titleText: '<fmt:message key="dest_nm" />'}
				]
			});
		}

		function fnInitGridComplete(initGridNm){
			addGridRow(5, 'htmlTable', 'datarow');
			row_no = jQuery("#htmlTable").getDataIDs().length; 
		}

		function setChangeImg(){
			var gridRow  = $("#"+gridName2);
			var ids      = gridRow.getDataIDs();

			for(var i=0;i<ids.length;i++){
				var imgSrc = "";
				imgSrc = "<img src='../../images/hncis_bttn/set_amount.gif' onClick='gridSetAmount(\""+ids[i]+"\");'/>";
				gridRow.jqGrid("setRowData", ids[i], {set_amt:imgSrc});
			}
		}

		function chk_auth(){
			var f = document.frm;

			with(f){
				if(sess_auth < 5 && sess_mstu != "M"){
					readOnlyStyle("eeno", 1);
					readOnlyStyle("snb_rson_sbc", 1);
				}else{
					readOnlyStyle("snb_rson_sbc", 2);
					if($("#M_DOC_NO").val() != ""){
						readOnlyStyle("eeno", 1);
					}else{
						readOnlyStyle("eeno", 2);
					}
				}
			}
		}

		function retrieve(btnFlag){
			var f = document.frm;
			switch(btnFlag){
			   case "search" :
				    doSearch();
					break;
			   case "save" :
				   doInsert();
					break;
			   case "edit" :
				    doModify();
				    break;
			   case "delete" :
				    if(!processValidation(btnFlag))return;
				    doDelete();
					break;
			   case "request" :
				    doApprove();
					break;
			   case "requestCancel" :
				    doApproveCancel();
					break;
			   case "confirmCancel" :
				    doConfirmCancel();
					break;
			   case "confirm" :
				    doConfirm();
					break;
			   case "reject" :
				    doReject();
					break;
			   case "back" :
				   doBack();
				   break;
			   case "new" :
				   doNew();
				   break;
			   case "print" :
				   doPrint();
				   break;
			}
		}

		function processValidation(gubun){
			var pgs_st_cd = $("#pgs_st_cd").val();
			var flag      = false;

			var isAdmin = sess_mstu == "M" || sess_auth >= 5;
			var isWriter = $("#ipe_eeno").val() == sess_empno;

			if(pgs_st_cd == '' && gubun != 'save'){
				alertUI('<fmt:message key="MSG.STAT.0047"/>');
				return false;
			}

			if(gubun == "save"){						//저장
				if(isAdmin){
					if(pgs_st_cd == '3'){
						alertUI('<fmt:message key="MSG.STAT.0002"/>');	//저장할 수 없는 상태입니다.
					} else {
						flag = true;
					}
				} else {
					if(pgs_st_cd == ''){
						flag = true;
					} else if(pgs_st_cd == '0'){
						if(isWriter){
							flag = true;
						} else {
							alertUI('<fmt:message key="MSG.STAT.0039"/>');	//신청자만이 요청할 수 있습니다.
						}
					} else if(pgs_st_cd == '3'){
						alertUI('<fmt:message key="MSG.STAT.0002"/>');	//저장할 수 없는 상태입니다.
					} else {
						alertUI('<fmt:message key="MSG.STAT.0002"/>');	//저장할 수 없는 상태입니다.
					}
				}
			}else if(gubun == "edit"){						//저장
				if(isAdmin){
					if(pgs_st_cd == '3'){
						alertUI('<fmt:message key="MSG.STAT.0002"/>');	//저장할 수 없는 상태입니다.
					} else {
						flag = true;
					}
				} else {
					if(pgs_st_cd == '0'){
						if(isWriter){
							flag = true;
						} else {
							alertUI('<fmt:message key="MSG.STAT.0039"/>');	//신청자만이 요청할 수 있습니다.
						}
					} else if(pgs_st_cd == '3'){
						alertUI('<fmt:message key="MSG.STAT.0002"/>');	//저장할 수 없는 상태입니다.
					} else {
						alertUI('<fmt:message key="MSG.STAT.0002"/>');	//저장할 수 없는 상태입니다.
					}
				}
			} else if(gubun == "delete"){				//삭제
				if(isAdmin){
					if(pgs_st_cd == '3'){
						alertUI('<fmt:message key="MSG.STAT.0003"/>');	//삭제할 수 없는 상태입니다.
					} else {
						flag = true;
					}
				} else {
					if(pgs_st_cd == '0'){
						if(isWriter){
							flag = true;
						} else {
							alertUI('<fmt:message key="MSG.STAT.0039"/>');	//신청자만이 요청할 수 있습니다.
						}
					} else if(pgs_st_cd == '3'){
						alertUI('<fmt:message key="MSG.STAT.0003"/>');	//삭제할 수 없는 상태입니다.
					} else {
						alertUI('<fmt:message key="MSG.STAT.0003"/>');		//삭제할 수 없는 상태입니다.
					}

				}
			}

			return flag;
		}
		
		function doSearch(msgFlag){
			setFormClear();

			var keyData = {
					doc_no		: $('#M_DOC_NO').val(),
					corp_cd		: sess_corp_cd,
					locale		: sess_locale
			};
			paramData = {
					paramJson      	: util.jsonToString(keyData)
			};
			doCommonAjax("doSearchInfoPsToRequest.do", paramData, "loadCallBack(jsonData.sendResult,'"+msgFlag+"');");
		}

		/**
		 * callback
		 */
		function loadCallBack(result,msgFlag){
			loadJsonSet(result);

			if(msgFlag != 'N'){
				setBottomMsg(result.message, false);
			}

			if(Number(result.file_cnt) > 0){
				$('#file_yn').val('Y');
			}
			else{
				$('#file_yn').val('N');
			}

			fnSubmitInfoSettings($("#pgs_st_cd").val(), $("#if_id").val(), result.code, "snb_rson_sbc", $("#approveStepLevel").val());

			$("#cost_cd").val(result.cost_cd);

			init();
		}

		function doSerchList(msgFlag){
			params = {
					doc_no		: $('#M_DOC_NO').val(),
					corp_cd		: sess_corp_cd,
					locale		: sess_locale
			};
			doCommonSearch("doSearchListPsToRequest.do",util.jsonToString(params), "loadCallBackList();", "htmlTable", msgFlag);
		}

		function loadCallBackList(){
			if(fnMerge !== ""){
				eval(fnMerge);
			}

			addGridRow(5, "htmlTable", 'datarow');

			row_no = jQuery("#htmlTable").getDataIDs().length;
		}

		function doInsert(){

			var docNo = "";

			if($("#work_auth").val() < 5 && sess_mstu != "M"){
				if($("#doc_no").val() != ''){
					if(sess_empno != $("#ipe_eeno").val()){
						alertUI('<fmt:message key="MSG.STAT.0015"/>');
						return;
					};
					if($("#pgs_st_cd").val() != '0'){
						alertUI('<fmt:message key="MSG.STAT.0002"/>');
						return;
					}
				}

				if(!($("#pgs_st_cd").val() == '' || $("#pgs_st_cd").val() == '0')){
					alertUI('<fmt:message key="MSG.STAT.0002"/>');
					return;
				}
			}


			if($("#doc_no").val() == ""){
				$("#M_DOC_NO").val($("#T_DOC_NO").val());
			}

			docNo = $("#M_DOC_NO").val();

			var psParams = [];
			var ids = jQuery("#htmlTable").getDataIDs();

			var lstCnt = 0;

			for(var i = 0; i < ids.length; i++){
				rowId = ids[i];
				if(rowId)	{
					if(getColValue("stap_cd",rowId) != '' && getColValue("arvp_cd",rowId) != ''){
						if(getColValue("rem_sbc",rowId) == ''){
							alertUI(rowId + '<fmt:message key="MSG.ROW.0002"/>');
							return;
						}

						data =
						{
								doc_no 			: docNo,
								seq 			: getColValue("seq",rowId),
								stap_ymd 		: selectNum(getColValue("stap_ymd",rowId)),
								sta_hhmm		: selectNum(getColValue("sta_hhmm",rowId)),
								stap_cd			: getColValue("stap_cd",rowId),
								stap_adr		: getColValue("stap_adr",rowId),
								arvp_cd			: getColValue("arvp_cd",rowId),
								arvp_adr		: getColValue("arvp_adr",rowId),
								rem_sbc			: getColValue("rem_sbc",rowId),
								flht_no			: getColValue("flht_no",rowId),
								svca_amt		: "0",
								ipe_eeno		: sess_empno,
								updr_eeno		: sess_empno,
								corp_cd			: sess_corp_cd,
								locale			: sess_locale
						};
						psParams.push(data);
						lstCnt++;
					}
				} else { alertUI('<fmt:message key="MSG.INP.0049"/>');}
			}

			if($("#car_type_cd").val() == ""){
				alertUI('<fmt:message key="MSG.SEL.0025"/>');
				return;
			}

			var keyData = {
				doc_no      		: docNo,
				eeno      			: $("#eeno").val(),
				ptt_ymd      		: selectNum($("#ptt_ymd").val()),
				car_type_cd      	: $("#car_type_cd").val(),
				purp_sbc      		: changeToUni($("#purp_sbc").val()),
				pgs_st_cd			: '0',
				acpc_pgs_st_cd		: '0',
				agree_flag     		: "Y",
				dept_cd				: sess_dept_code,
				ipe_eeno			: sess_empno,
				updr_eeno			: sess_empno,
				corp_cd				: sess_corp_cd,
				locale				: sess_locale
			};

			if(lstCnt == 0){
				alertUI('<fmt:message key="MSG.INP.0049"/>');
				return;
			}

			confirmUI('<fmt:message key="MSG.CNF.0004"/>');
			$("#pop_yes").click(function(){
				$.unblockUI({
					onUnblock: function(){
						var paramData = {
							paramJsonList 			: util.jsonToList(psParams),
							paramJsonStr 			: util.jsonToString(keyData)
						};
						doCommonAjax("doInsertPsToRequest.do", paramData, "setBottomMsg(jsonData.sendResult.message, true);insertCallBack(jsonData.sendResult);");
					}
				});
			});
		}

		function insertCallBack(result){
			if(result.code1 == "Y"){
				$("#M_DOC_NO").val(result.code);
				doSearch('N');
			}

		}

		function doDelete(){
			
			if(!processFlag("delete")) return;
			
			if($("#work_auth").val() < 5 && sess_mstu != "M"){
				if($("#pgs_st_cd").val() != '0'){
					alertUI('<fmt:message key="MSG.STAT.0003"/>');
					return;
				}
				if(sess_empno != $("#ipe_eeno").val()){
					alertUI('<fmt:message key="MSG.VAL.0037"/>');
					return;
				}
			}

			if($("#pgs_st_cd").val() == '2'){
				alertUI('<fmt:message key="MSG.STAT.0003"/>');
				return;
			}

			var keyData = {
					doc_no		: $("#doc_no").val(),
					corp_cd		: sess_corp_cd,
					locale		: sess_locale
			};

			confirmUI('<fmt:message key="MSG.CNF.0002"/>');
			$("#pop_yes").click(function(){
				$.unblockUI({
					onUnblock: function(){
						var paramData = {
								paramJson : util.jsonToString(keyData)
						};
						doCommonAjax("doDeletePsToRequest.do", paramData, "setBottomMsg(jsonData.sendResult.message, true);doSearchFormAfterDel('N');");
					}
				});
			});
		}

		function doSearchFormAfterDel(msgFlag){
			setFormClear();

			$("#T_DOC_NO").val(getTmpDocNo());
			$("#M_DOC_NO").val("");
			$("#hid_doc_no").val("");
			$("#M_DOC_NO").val($("#T_DOC_NO").val());

			var keyData = {
				doc_no		: $('#M_DOC_NO').val(),
				corp_cd		: sess_corp_cd,
				locale		: sess_locale
			};
			paramData = {
				paramJson      	: util.jsonToString(keyData)
			};
			doCommonAjax("doSearchInfoPsToRequest.do", paramData, "loadCallBackFormAfterDel(jsonData.sendResult,'"+msgFlag+"');");
		}

		/**
		 * callback
		 */
		function loadCallBackFormAfterDel(result,msgFlag){
			$("#htmlTable").jqGrid("clearGridData", true);
			addGridRow(5);
			$("#"+gridName2).jqGrid("clearGridData", true);
			addGridRow(5, gridName2, 'datarow_driver');

			setLoadUserInfo();
		}

		function doApprove(){
			
			if(!processFlag("request")) return;
			
			if( !($("#ipe_eeno").val() == sess_empno || sess_mstu == "M" || parseInt($("#work_auth").val()) > 4) ){
				alertUI('<fmt:message key="MSG.STAT.0018"/>');
				return;
			}
			if($("#pgs_st_cd").val() != '0'){
				alertUI('<fmt:message key="MSG.STAT.0005"/>');
				return;
			}

			var keyData = {
				doc_no			 	: $("#doc_no").val(),
				pgs_st_cd		 	: 'A',
				updr_eeno 			: sess_empno,
				cost_cd				: $("#cost_cd_h").val(),
				eeno				: $("#eeno").val(),
				eeno_nm				: $("#eeno_nm").val(),
				tot_amt				: 0,
				corp_cd				: sess_corp_cd,
				locale				: sess_locale
			};


			fnStartLoading();

			confirmUI('<fmt:message key="MSG.CNF.0005"/>');
			$("#pop_yes").click(function(){
				$.unblockUI({
					onUnblock: function(){
						var paramData = {
								paramJson : util.jsonToString(keyData)
						};
						doCommonAjax("doApprovePsToRequest.do", paramData, "actionCallBack(jsonData.sendResult);");
					}
				});
			});
		}

		function doApproveCancel(){
			
			if(!processFlag("requestCancel")) return;
			
			if( $("#apprLev1").val() == "" ){
				if($("#pgs_st_cd").val() != 'Z'){
					alertUI('<fmt:message key="MSG.STAT.0006"/>');
					return;
				}
			}else{
				if($("#pgs_st_cd").val() != 'A'){
					alertUI('<fmt:message key="MSG.STAT.0006"/>');
					return;
				}
			}
			
			//작성 중인 사람이 아닌 경우에는 cancel할 수 없음.
			if( !($("#ipe_eeno").val() == sess_empno || sess_mstu == "M" || parseInt($("#work_auth").val()) > 4) ){
				alertUI('<fmt:message key="MSG.STAT.0019"/>');
				return;
			}
			var keyData = {
					pgs_st_cd		 : '0',
					updr_eeno		 : sess_empno,
					po_no			 : $("#po_no").val(),
					doc_no			 : $("#doc_no").val(),
					if_id			 : $("#if_id").val(),
					corp_cd			 : sess_corp_cd,
					locale			 : sess_locale
			};

			fnStartLoading();

			confirmUI('<fmt:message key="MSG.CNF.0006"/>');
			$("#pop_yes").click(function(){
				$.unblockUI({
					onUnblock: function(){
						var paramData = {
								paramJson : util.jsonToString(keyData)
						};
						doCommonAjax("doApproveCancelPsToRequest.do", paramData, "actionCallBack(jsonData.sendResult);");
					}
				});
			});
		}

		function doConfirm(){
			
			if(!processFlag("confirm")) return;
			
			if($("#pgs_st_cd").val() != 'Z'){
				alertUI('<fmt:message key="MSG.STAT.0022"/>');
				return;
			}

			if($("#work_auth").val() < 5 && sess_mstu != "M" && $("#work_auth").val() != '6'){
				alertUI('<fmt:message key="MSG.STAT.0022"/>');
				return;
			}

			var psParams = [];
			var ids = jQuery("#htmlTable").getDataIDs();

			for(var i = 0; i < ids.length; i++){
				rowId = ids[i];
				if(rowId)	{
					if(getColValue("stap_cd",rowId)!=''&getColValue("arvp_cd",rowId)!=''){
						if(getColValue("rem_sbc",rowId) == ''){
							alertUI('<fmt:message key="MSG.INP.0067"/>');
							return;
						}
						data =
						{
								doc_no 			: getColValue("doc_no",rowId),
								seq 			: getColValue("seq",rowId),
								stap_ymd 		: selectNum(getColValue("stap_ymd",rowId)),
								sta_hhmm		: selectNum(getColValue("sta_hhmm",rowId)),
								stap_cd			: getColValue("stap_cd",rowId),
								stap_adr		: getColValue("stap_adr",rowId),
								arvp_cd			: getColValue("arvp_cd",rowId),
								arvp_adr		: getColValue("arvp_adr",rowId),
								rem_sbc			: getColValue("rem_sbc",rowId),
								flht_no			: getColValue("flht_no",rowId),
								svca_amt		: "0",
								ipe_eeno		: sess_empno,
								updr_eeno		: sess_empno,
								corp_cd			: sess_corp_cd,
								locale			: sess_locale
						};
						psParams.push(data);

					}
				} else { alertUI('<fmt:message key="MSG.SEL.0011"/>');}
			}

			var keyData = {
					doc_no      		: $("#doc_no").val(),
					eeno      			: $("#eeno").val(),
					ptt_ymd      		: selectNum($("#ptt_ymd").val()),
					car_type_cd      	: $("#car_type_cd").val(),
					purp_sbc      		: $("#purp_sbc").val(),
					cost_cd				: $("#cost_cd_h").val(),
					acpc_type			: '6',
					acpc_eeno			: sess_empno,
					acpc2_eeno			: sess_empno,
					po_no				: $("#po_no").val(),
					corp_cd				: sess_corp_cd,
					locale				: sess_locale

			};

			fnStartLoading();

			confirmUI('<fmt:message key="MSG.CNF.0007"/>');
			$("#pop_yes").click(function(){
				$.unblockUI({
					onUnblock: function(){
						var paramData = {
								paramJsonList 			: util.jsonToList(psParams),
								paramJsonStr 			: util.jsonToString(keyData)
							};
							doCommonAjax("doConfirmPsToRequest.do", paramData, "actionCallBack(jsonData.sendResult);");
					}
				});
			});
		}

		function doConfirmCancel(){
			
			if(!processFlag("confirmCancel")) return;
			
			if($("#pgs_st_cd").val() != '3'){
				alertUI('<fmt:message key="MSG.STAT.0023"/>');
				return;
			}

			if($("#snb_rson_sbc").val() == ""){
				alertUI('<fmt:message key="MSG.INP.0011"/>');
				$("#snb_rson_sbc").focus();
				return;
			}

			var keyData = {
					doc_no			 : $("#doc_no").val(),
					eeno			 : $("#eeno").val(),
					pgs_st_cd		 : '0',
					snb_rson_sbc  	 : changeToUni($("#snb_rson_sbc").val()),
					updr_eeno		 : sess_empno,
					corp_cd			 : sess_corp_cd,
					locale			 : sess_locale
			};

			fnStartLoading();

			confirmUI("Do you want to cancel confirm?");
			$("#pop_yes").click(function(){
				$.unblockUI({
					onUnblock: function(){
						var paramData = {
								paramJson : util.jsonToString(keyData)
						};
						doCommonAjax("doConfirmCancelPsToRequest.do", paramData, "actionCallBack(jsonData.sendResult);");
					}
				});
			});
		}

		function doReject(){
			
			if(!processFlag("reject")) return;
			
			if($("#pgs_st_cd").val() != 'Z'){
				alertUI('<fmt:message key="MSG.STAT.0011"/>');
				return;
			}

			if( !($("#work_auth").val() == '5' || sess_mstu == "M") ){
				alertUI('<fmt:message key="MSG.STAT.0011"/>');
				return;
			}else if($("#work_auth").val() == '6'){
				if(!($("#pgs_st_cd").val() == 'Z' || $("#pgs_st_cd").val() == '3' || $("#pgs_st_cd").val() == 'A')){
					alertUI('<fmt:message key="MSG.STAT.0011"/>');
					return;
				}
// 			}else{
// 				alertUI('<fmt:message key="MSG.STAT.0024"/>');
// 				return;
			}

			if($("#snb_rson_sbc").val() == ""){
				alertUI('<fmt:message key="MSG.INP.0011"/>');
				$("#snb_rson_sbc").focus();
				return;
			}

			var keyData = {
					doc_no			 : $("#doc_no").val(),
					eeno			 : $("#eeno").val(),
					pgs_st_cd		 : '2',
					acpc_pgs_st_cd	 : '0',
					snb_rson_sbc  	 : changeToUni($("#snb_rson_sbc").val()),
					updr_eeno		 : sess_empno,
					corp_cd			 : sess_corp_cd,
					locale			 : sess_locale
			};

			fnStartLoading();

			confirmUI('<fmt:message key="MSG.CNF.0010"/>');
			$("#pop_yes").click(function(){
				$.unblockUI({
					onUnblock: function(){
						var paramData = {
								paramJson : util.jsonToString(keyData)
						};
						doCommonAjax("doRejectPsToRequest.do", paramData, "actionCallBack(jsonData.sendResult);");
					}
				});
			});
		}

		function actionCallBack(result){
			fnEndLoading();
			setBottomMsg(result.message, true);
			doSearch('N');
		}


		function setLoadUserInfo(){

			setFormClear();

			$("#eeno").val(sess_empno);
			$("#eeno_nm").val(sess_name);
			$("#pos_nm").val(sess_step_name);
			$("#dept_nm").val(sess_dept_name);
			$("#tel_no").val(sess_tel_no);
			$("#ptt_ymd").val(getCurrentToDateAddDayEn("-",0));
		}

		 function setFormClear(){
			$('#eeno').val("");
			$('#eeno_nm').val("");
			$('#pos_nm').val("");
			$('#dept_nm').val("");
			$('#ptt_ymd').val("");
			$('#doc_no').val("");
			$('#pgs_st_cd_d').val("");
			$('#pgs_st_cd').val("");
			$("#tel_no").val("");
			$('#snb_rson_sbc').val("");
			$('#ipe_eeno').val("");

			$('#car_type_cd').val("");
			$('#purp_sbc').val("");
			$('#cost_cd').val("");
			$('#rem_sbc').val("");

			$('#cost_cd_h').val("");
			$("#file_yn").val("");
		}

		 function cearInsa(){
			if($("#eeno").val() == ""){
				$("#eeno").val("");
				$("#eeno_nm").val("");
				$("#pos_nm").val("");
				$("#dept_nm").val("");
				$("#tel_no").val("");
			}
		}

		function setInsaInfo(){
			if($("#eeno").val() != ""){
				var keyData = {
						xusr_empno : $("#eeno").val(),
						corp_cd	   : sess_corp_cd,
						locale	   : sess_locale
				};
				paramData = {
					paramJson : util.jsonToString(keyData)
				};
				doCommonAjax("/doSearchToUserInfo.do", paramData, "insaCallBack(jsonData.sendResult)");
			}
		}

		/**
		 * callback
		 */
		function insaCallBack(result){
			setBottomMsg(result.message, false);
// 			$("#eeno").val(result.xusr_empno);
			$("#eeno_nm").val(result.xusr_name);
			$("#pos_nm").val(result.xusr_step_name);
			$("#dept_nm").val(result.xusr_dept_name);
			$("#tel_no").val(result.xusr_tel_no);
		}

		function gridRowAdd(){
			row_no = row_no + 1;
			jQuery("#htmlTable").jqGrid("addRowData", row_no, datarow);
		}

		function gridRowDelete(){
			var selectRow = jQuery("#htmlTable").jqGrid("getGridParam", "selarrrow");
	
			if($("#pgs_st_cd").val() != '0' && $("#pgs_st_cd").val() != ''){
				alertUI('<fmt:message key="MSG.STAT.0003"/>');
				return;
			}

			if(selectRow.length == 0){
				alertUI('<fmt:message key="MSG.SEL.0022"/>');
				return;
			}

			var scheduleInfo = [];
			var data;

			for(var i=0; i<selectRow.length; i++){
				if(selectRow[i]){
					if(getColValue("doc_no", selectRow[i]) != ""){
						data = {
							doc_no : getColValue("doc_no", selectRow[i]),
							seq    : getColValue("seq"   , selectRow[i]),
							corp_cd	: sess_corp_cd,
							locale	: sess_locale
						};
						scheduleInfo.push(data);
					}
				}
			}

			confirmUI('<fmt:message key="MSG.CNF.0026"/>');
			$("#pop_yes").click(function(){
				$.unblockUI({
					onUnblock: function(){
						if(scheduleInfo.length > 0){
							var paramData = {
								paramJson : util.jsonToList(scheduleInfo)
							};
							doCommonAjax("doDeleteScheduleToRequest.do", paramData, "setBottomMsg(jsonData.sendResult.message, true);gridRowDeleteCallBack();");
						}else{
							gridRowDeleteCallBack();
						}
					}
				});
			});
		}

		function gridRowDeleteCallBack(){
			var selectRow = jQuery("#htmlTable").jqGrid("getGridParam", "selarrrow");
			// grid row 삭제
			for(var i=selectRow.length; i>=0; i--){
				var rowId = selectRow[i-1];
				$("#htmlTable").delRowData(rowId); 
			}
			
			if(jQuery("#htmlTable").getDataIDs().length < 5){
				var rowCnt = 5 - jQuery("#htmlTable").getDataIDs().length;
				for(var i=0; i < rowCnt; i++){
					gridRowAdd();
				}
			}
		}

		function gridRowDelete2(){
			var rowId = jQuery("#"+gridName2).jqGrid("getGridParam", "selrow");

			if($("#pgs_st_cd").val() != '0'){
				alertUI('<fmt:message key="MSG.STAT.0003"/>');
				return;
			}

			if(rowId == "" || rowId == null){
				alertUI('<fmt:message key="MSG.SEL.0018"/>');
				return;
			}else if(getColValue("doc_no", rowId,gridName2) == "" ){
				alertUI('<fmt:message key="MSG.VAL.0009"/>');
				return;
			}

			var scheduleInfo = {
					doc_no          : getColValue("doc_no", rowId,gridName2),
					seq          	: getColValue("seq", rowId,gridName2),
					corp_cd			: sess_corp_cd,
					locale			: sess_locale
			};

			confirmUI("Do you want to Delete Driver Info?");
			$("#pop_yes").click(function(){
				$.unblockUI({
					onUnblock: function(){
						var paramData = {
								paramJson : util.jsonToString(scheduleInfo)
						};
						doCommonAjax("doDeleteDriverInfoToRequest.do", paramData, "setBottomMsg(jsonData.sendResult.message, true);doSearch();");
					}
				});
			});
		}

		function gridRowAdd2(){
			var gridRowId = jQuery("#"+gridName2).getDataIDs().length;
			jQuery("#"+gridName2).jqGrid("addRowData", gridRowId+1, datarow_driver);

			var imgSrc = "";
			imgSrc = "<img src='../../images/hncis_bttn/set_amount.gif' onClick='gridSetAmount(\""+gridRowId+1+"\");'/>";
			$("#htmlTable2").jqGrid("setRowData", gridRowId+1, {set_amt:imgSrc});

			initAfterMenus();
		}

		var win;
		function doFileAttach(seq){

			if(win != null){ win.close(); }
			var url = "xps01_file.gas", width = "460", height = "453";

			if($("#M_DOC_NO").val() == ""){
				$("#hid_doc_no").val($("#T_DOC_NO").val());
			}else{
				$("#hid_doc_no").val($("#M_DOC_NO").val());
			}

			$("#hid_eeno").val("00000000");
			$("#hid_seq").val('1');

			if($("#work_auth").val() < 5 && sess_mstu != "M"){
				if(sess_empno == $("#eeno").val()){
					if($("#pgs_st_cd").val() == "0" || $("#pgs_st_cd").val() == ""){
						$("#hid_use_yn").val("Y");
					}
					else{
						$("#hid_use_yn").val("N");
					}
				}
				else{
					$("#hid_use_yn").val("N");
				}
			}
			else{
				$("#hid_use_yn").val("Y");
			}


			win = newPopWin("about:blank", width, height, "win_file");
			document.fileForm.hid_csrfToken.value = $("#csrfToken").val();
			document.fileForm.action = url;
			document.fileForm.target = "win_file";
			document.fileForm.method = "post";
			document.fileForm.submit();

		}

		var schedule_win;
		function fnAddSchedule(){
			if(schedule_win != null){ schedule_win.close(); }
			var url = "xps01_schedule.gas", width = "1000", height = "540";

			schedule_win = newPopWin("about:blank", width, height, "schedule_win");
			document.fileForm.hid_csrfToken.value = $("#csrfToken").val();
			document.fileForm.action = url;
			document.fileForm.target = "schedule_win";
			document.fileForm.method = "post";
			document.fileForm.submit();
		}

		function fnCopyData(dataRows){
			var allRow = $("#htmlTable").getDataIDs();
			var loopCnt = dataRows.length;
			var dataIdx = 0;

			for(var i=0; i<loopCnt; i++){
				if( allRow[i] ){
					if( getColValue("seq"     , allRow[i]) != "" ||
						getColValue("add_flag", allRow[i]) != "" ){
						loopCnt++;
					}else{
							$("#htmlTable").jqGrid("setRowData", allRow[i]  , dataRows[dataIdx++]);
					}
				}else{
					var gridRowId = jQuery("#htmlTable").getDataIDs().length;
					$("#htmlTable").jqGrid("addRowData", gridRowId + 1, dataRows[dataIdx++]);
				}
			}
		}

		function doBack(){
		    var form = $("<form/>");
		    form.attr("method" , "post");
		    form.attr("id"     , "submitForm").attr("name", "submitForm");
		    form.attr("action" , $("#hid_view_nm").val() + ".gas");
		    var inp1 = $("<input type='hidden' id='hid_cond' name='hid_cond'/>").val($("#hid_cond").val());
		    var token = $("<input type='hidden' id='hid_csrfToken' name='hid_csrfToken'/>").val($("#csrfToken").val());
		    form.append(inp1, token);
		    $("body").append(form);
		    form.submit();
		    form.remove();
		}

		function doNew(){
			setFormClear();
			$("#M_DOC_NO").val("");
			$("#T_DOC_NO").val(getTmpDocNo());
			$("#eeno").val(sess_empno);
			$("#eeno_nm").val(sess_name);
			$("#pos_nm").val(sess_step_name);
			$("#dept_nm").val(sess_dept_name);
			$("#ptt_ymd").val(getCurrentToDateAddDayEn("/",0));
			$("#cost_cd").val(sess_cost_cd);
			$("#eeno").val(sess_empno);
			
			setInsaInfo();
			displaySubmitClear(document);
			chk_auth();
			init();
		}

		function gridRowExcel(){
			var params = {
				doc_no		: $('#M_DOC_NO').val(),
				corp_cd		: sess_corp_cd,
				locale		: sess_locale
			};

			var params = [
		  		{name : 'fileName',		value : "Pickup Schedule"},
		  		{name : 'header',		value : util.jsonToArray(excelCn)},
		  		{name : 'headerName',	value : util.jsonToArray(excelCm)},
		  		{name : 'fomatter',		value : util.jsonToArray(excelFm)},
		  		{name : 'paramJson',	value : util.jsonToString(params)},
		  		{name : 'firstUseYn',	value : "Y"}
			];

			gridToExcel("#htmlTable", "doExcelPsToRequestPickupSchedule.excel", params);
		}

		function poComplete(){
			var diIds = jQuery("#"+gridName2).getDataIDs();
			var cnt = 0;

			for(var i = 0; i < diIds.length; i++){
				rowId = diIds[i];
				if(rowId)	{
					if(getColValue("h_driver_agency",rowId, gridName2) != ""){
						if(getColValue("driver_tot_amt", rowId, gridName2) == ""){
							alertUI(rowId + '<fmt:message key="MSG.ROW.0099"/>');
							return;
						}
						if(getColValue("f_po_no", rowId, gridName2) == ""){
							cnt++;
						}
					}
				} else {
					alertUI('<fmt:message key="MSG.INP.0034"/>');
				}
			}

			if(cnt == 0){
				alertUI('<fmt:message key="MSG.INP.0034"/>');
				return;
			}

			var keyData = {
				doc_no			: $('#doc_no').val(),
				eeno			: $("#eeno").val(),
				cost_cd			: $("#cost_cd").val(),
				po_no			: $("#po_no").val(),
				corp_cd			: sess_corp_cd
			};

			fnStartLoading();

			confirmUI("Do you want to complete?");
			$("#pop_yes").click(function(){
				$.unblockUI({
					onUnblock: function(){
						var paramData = {
								paramJson : util.jsonToString(keyData)
						};
						doCommonAjax("doCompletePickUpPo.do", paramData, "completeCallBack(jsonData.sendResult);");
					}
				});
			});
		}

		function completeCallBack(result){
			fnEndLoading();
			setBottomMsg(result.message, true);
			doSearch('N');
		}

		function doPrint(){
			$.printPreview.loadPrintPreview();
		}

		function pageStepHelpPopup(){
			if(popup != null ){
				popup.close();
			}

			popup = popUpWindow3($("#help_url").val());
		}
		
		function processFlag(gubun){
			if(gubun != "save"){
				if($("#doc_no").val() == ""){
					alertUI('<fmt:message key="MSG.STAT.0047"/>');
					return;
				}
			}
			return true;
		}
		</script>