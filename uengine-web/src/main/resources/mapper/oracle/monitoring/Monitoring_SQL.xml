<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
 
<mapper namespace="monitoring">
     
    <select id="selectNewWorkStatus" resultType="MonitoringVO">
        <![CDATA[
            SELECT 
			    TO_CHAR(INST.STARTEDDATE,'YYYY-MM-DD hh:mm:ss') AS STARTEDDATE,
				INST.DEFNAME,
				COUNT(1) AS TOTALCOUNT 
			FROM BPM_PROCINST INST
			INNER JOIN BPM_WORKLIST WL ON WL.INSTID = INST.INSTID
			WHERE INST.STATUS = 'Running'
				AND INST.ISDELETED = 0
				AND INST.ISSUBPROCESS = 0
				AND WL.STATUS IN ('NEW','CONFIRMED','DRAFT')
				AND SYSDATE-7 <= INST.STARTEDDATE AND INST.STARTEDDATE <= SYSDATE-1 
			GROUP BY TO_CHAR(INST.STARTEDDATE,'YYYY-MM-DD hh:mm:ss'), INST.DEFNAME
        ]]>
    </select>
    <select id="selectProgressStatusByTask" resultType="MonitoringVO">
        <![CDATA[
          SELECT 
			INST.DEFNAME, 		
			COUNT(1) AS TOTALCOUNT 
		FROM BPM_PROCINST INST
		WHERE INST.STATUS = 'Running'
			AND INST.ISDELETED = 0
			AND INST.ISSUBPROCESS = 0
		GROUP BY INST.DEFNAME
        ]]>
    </select>
	<select id="selectProcessingDelayStatusByTask" resultType="MonitoringVO">
        <![CDATA[
          SELECT 
			INST.DEFNAME,
			NVL(COUNT(CASE WHEN DUEDATE <= FINISHEDDATE THEN 1 END),0) AS DELAYEDCOUNT
		FROM BPM_PROCINST INST
		INNER JOIN BPM_PROCDEF DEF ON INST.DEFID = DEF.DEFID 
		WHERE INST.STATUS = 'Completed'
			AND INST.ISDELETED = 0
			AND INST.ISSUBPROCESS = 0
			AND DEF.OBJTYPE = 'process'
		GROUP BY INST.DEFNAME
        ]]>
    </select>
    <select id="selectTaskCompletedAverageTime" resultType="MonitoringVO">
        <![CDATA[
          SELECT 
			INST.DEFNAME,
			TO_CHAR(INST.FINISHEDDATE,'YYYY-MM-DD hh:mm:ss') AS FINISHEDDATE,
			TO_CHAR(AVG(INST.FINISHEDDATE - INST.STARTEDDATE)+1) AS WORKINGDAYAVG
		  FROM BPM_PROCINST INST
		  WHERE INST.STATUS = 'Completed'
			AND INST.ISDELETED = 0
			AND INST.ISSUBPROCESS = 0
		  GROUP BY INST.DEFNAME, TO_CHAR(INST.FINISHEDDATE,'YYYY-MM-DD hh:mm:ss')
        ]]>
    </select>
</mapper>